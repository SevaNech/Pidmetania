<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pidmetannya with Firebase</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 480px; margin: auto; }
  h1 { text-align: center; }
  .login, .user-list, .history-section { margin-top: 20px; }
  label, input { display: block; margin: 5px 0; width: 100%; font-size: 16px; }
  button { font-size: 18px; margin: 5px 5px 5px 0; padding: 8px 12px; }
  ul { list-style: none; padding-left: 0; }
  li { margin: 5px 0; font-size: 18px; }
  .user-item { margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
  .admin-label { font-weight: bold; color: red; }
</style>
</head>
<body>

<h1>Pidmetannya</h1>

<div class="login" id="loginDiv">
  <h2>Login</h2>
  <label>Nickname: <input type="text" id="nicknameInput" /></label>
  <label>Password: <input type="password" id="passwordInput" /></label>
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div class="user-list" id="userListDiv" style="display:none;">
  <h2>Users</h2>
  <div id="usersContainer"></div>
  <button onclick="logout()">Logout</button>
</div>

<div class="history-section" id="historyDiv" style="display:none;">
  <h2>History for <span id="currentUserName"></span></h2>
  <button onclick="addMark('+')">+</button>
  <button onclick="addMark('-')">−</button>
  <ul id="historyList"></ul>
</div>

<script>
  // ---- Firebase Config ----
  const firebaseConfig = {
    apiKey: "AIzaSyAdCQbwBXO2htS1yGAb-MbCcmg6Gh7QzkY",
    authDomain: "pidmetania.firebaseapp.com",
    databaseURL: "https://pidmetania-default-rtdb.firebaseio.com",
    projectId: "pidmetania",
    storageBucket: "pidmetania.firebasestorage.app",
    messagingSenderId: "157835623349",
    appId: "1:157835623349:web:ac15076f8cb13501c377fc"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---- Аккаунти ----
  const accounts = {
    "Elya": { password: "1234", isAdmin: false },
    "Vilou": { password: "5678", isAdmin: false },
    "Seva": { password: "0107", isAdmin: true } // адмін, але не показуємо "admin"
  };

  let loggedInUser = null;
  let viewingUser = null;

  // ---- Логін ----
  function login() {
    const nick = document.getElementById("nicknameInput").value.trim();
    const pass = document.getElementById("passwordInput").value.trim();
    const errorEl = document.getElementById("loginError");

    if (!accounts[nick]) {
      errorEl.textContent = "User not found";
      return;
    }
    if (accounts[nick].password !== pass) {
      errorEl.textContent = "Wrong password";
      return;
    }

    loggedInUser = nick;
    errorEl.textContent = "";
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("userListDiv").style.display = "block";

    renderUsers();
  }

  // ---- Вихід ----
  function logout() {
    loggedInUser = null;
    viewingUser = null;
    document.getElementById("loginDiv").style.display = "block";
    document.getElementById("userListDiv").style.display = "none";
    document.getElementById("historyDiv").style.display = "none";
    document.getElementById("nicknameInput").value = "";
    document.getElementById("passwordInput").value = "";
  }

  // ---- Відобразити список користувачів ----
  function renderUsers() {
    const container = document.getElementById("usersContainer");
    container.innerHTML = "";

    for (const nick in accounts) {
      const user = accounts[nick];

      const div = document.createElement("div");
      div.className = "user-item";

      // Відображаємо ніки (без слова "admin" для Seva)
      const userLabel = document.createElement("span");
      userLabel.textContent = nick + (user.isAdmin && nick !== "Seva" ? " (admin)" : "");
      div.appendChild(userLabel);

      // Кнопка "View History"
      const viewBtn = document.createElement("button");
      viewBtn.textContent = "History Pidmetannya";
      viewBtn.onclick = () => openHistory(nick);
      div.appendChild(viewBtn);

      // Адмін може міняти ніки і паролі
      if (accounts[loggedInUser].isAdmin) {
        // Поле для зміни ніку
        const nickInput = document.createElement("input");
        nickInput.value = nick;
        nickInput.style.marginLeft = "10px";
        nickInput.onchange = () => changeNickname(nick, nickInput.value);
        div.appendChild(nickInput);

        // Поле для зміни пароля
        const passInput = document.createElement("input");
        passInput.type = "password";
        passInput.placeholder = "New password";
        passInput.style.marginLeft = "5px";
        passInput.onchange = () => changePassword(nick, passInput.value);
        div.appendChild(passInput);
      }

      container.appendChild(div);
    }
  }

  // ---- Змінити ніки (проста логіка) ----
  function changeNickname(oldNick, newNick) {
    if (!newNick || newNick === oldNick || accounts[newNick]) {
      alert("Invalid or existing nickname");
      renderUsers();
      return;
    }
    accounts[newNick] = accounts[oldNick];
    delete accounts[oldNick];

    // Також можна перенести історію у Firebase, якщо хочеш
    // Але це складніше — поки просто оновлюємо локально
    renderUsers();
  }

  // ---- Змінити пароль ----
  function changePassword(nick, newPass) {
    if (!newPass) {
      alert("Password cannot be empty");
      return;
    }
    accounts[nick].password = newPass;
  }

  // ---- Відкрити історію користувача ----
  function openHistory(nick) {
    viewingUser = nick;
    document.getElementById("currentUserName").textContent = nick;
    document.getElementById("historyDiv").style.display = "block";
    loadHistory(nick);
  }

  // ---- Додати "+" або "−" ----
  function addMark(mark) {
    if (!viewingUser) return;
    const timestamp = Date.now();
    db.ref('users/' + viewingUser + '/marks/' + timestamp).set(mark);
  }

  // ---- Підвантажити історію з Firebase і оновити список ----
  function loadHistory(nick) {
    const historyList = document.getElementById("historyList");
    db.ref('users/' + nick + '/marks').on('value', snapshot => {
      const data = snapshot.val();
      historyList.innerHTML = "";
      if (data) {
        const sortedKeys = Object.keys(data).sort();
        sortedKeys.forEach(key => {
          const li = document.createElement("li");
          li.textContent = data[key];
          historyList.appendChild(li);
        });
      }
    });
  }
</script>

</body>
</html>
